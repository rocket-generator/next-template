# 認証が必要なページに未認証ユーザーがアクセスした場合、リダイレクトする

認証関係（ /signin など src/app/(site)/(unauthorized)/(auth) 以下のページ）にログイン済みのユーザーがアクセスした場合、ダッシュボードにリダイレクトするようにする。

ただし、ログイン済みのユーザーがアクセスした場合でも、リダイレクトしたくないというリクエストがある場合もあるので、環境変数で制御できるようにする（リダイレクトするかしないかを）。

---

## 追記: 実装計画（2026-01-25）

### 背景
- 現在は `src/app/(site)/(unauthorized)/(auth)/layout.tsx` でセッションがある場合に `/dashboard` へリダイレクトしているが、環境変数で無効化できない。
- `UserRepository.getMe()` の結果に依存しており、取得失敗時にリダイレクトが発生しない可能性がある（要件と不整合）。
- 認証関連ページ全体に共通の挙動にしたいため、レイアウトに集約するのが最適。

### 方針とその理由
- **リダイレクト制御は `src/app/(site)/(unauthorized)/(auth)/layout.tsx` に集約**する。既存構造上、認証ページ配下に一括適用できるため。
- **環境変数フラグで有効/無効を切り替える**。既存の `ENABLE_*` 形式に合わせ、デフォルトは `true` にして現行挙動を維持する。
- **セッションが存在すれば即時リダイレクト**とし、`UserRepository.getMe()` への依存を減らす。要件を確実に満たし、不要な DB アクセスやログ出力を避けるため。

### 具体的なタスク
- [x] 現状確認: `src/app/(site)/(unauthorized)/(auth)/layout.tsx` のリダイレクト条件と例外処理の流れを整理する。
- [x] 現状確認: `.env.example` / `.env` の命名規則を確認し、追加する環境変数名の候補を決める（例: `ENABLE_AUTH_PAGE_REDIRECT`）。
- [x] 仕様確定: フラグのデフォルト値（`true` 想定）と挙動（`true`=リダイレクト、`false`=表示）を明文化する。
- [x] 実装: `src/app/(site)/(unauthorized)/(auth)/layout.tsx` にフラグ判定を追加し、`true` の場合のみ `/dashboard` へリダイレクトする。
- [x] 実装: セッションが存在する場合は `UserRepository.getMe()` を呼ばず即時リダイレクトする構成に変更し、失敗時に挙動が揺れないようにする。
- [x] ドキュメント: `.env.example` に新規フラグを追記し、必要であれば README の設定例も更新する。
- [ ] テスト/確認: ログイン済み/未ログイン × フラグON/OFF の4パターンで `/signin` などの挙動を確認する（E2E もしくは手動テスト手順を用意）。
